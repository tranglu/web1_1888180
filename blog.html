<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>1888180-ice-creams</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900&display=swap" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script><!-- mới thêm dòng script này nè -->
    <link href="https://fonts.googleapis.com/css?family=Changa+One:400,400i&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="shorcut icon" href="images/favicon.ico" type="image/x-icon">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="icecream.css">

<body>
    <!-- Phần header -->
    <header>
        <div class="container">
            <nav class="navbar navbar-expand-lg navbar-light bg-inverse">
                <div class="container">
                    <a class="navbar-brand logo col-1" href="index.html">
                        <img src="images/logo.png" alt="">
                    </a>
                    <button class="navbar-toggler hidden-sm-up float-right" type="button" data-toggle="collapse" data-target="#navbarTogglerDemo02" aria-controls="navbarTogglerDemo02">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                    <div class="collapse navbar-collapse" id="navbarTogglerDemo02">
                        <ul class="nav navbar-nav ml-auto">
                            <li class="nav-item">
                                <a class="nav-link" href="index.html">Home</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="about.html">About</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="menu.html">Menu</a>
                            </li>
                            <li class="nav-item active">
                                <a class="nav-link" href="blog.html">Blog</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="contact.html">Contacts</a>
                            </li>
                        </ul>
                        <form class="form-inline navbar-form pull-left">
                            <input class="form-control" type="text" placeholder="Search">
                            <img class="search-button" src="images/search_button.png" alt="">
                        </form>
                        <div class="social">
                            <a href="" class="twitter"></a>
                            <a href="" class="facebook"></a>
                        </div>
                    </div>
                </div>
            </nav> <!-- hết navbar -->
        </div>
    </header> <!-- hết header -->
    <!--    Phần banner -->
    <div class="banner container-fluid" id="small-banner">
    </div> <!-- hết banner -->
    <!--   phần main -->
    <div>
        <div class="container">
            <div class="row">
                <div class="col-12 col-md-9">
                    <h2>BLOG</h2>
                    <!-- Portfolio Gallery Grid -->
                    <div class="row" id="blogs">
                    </div>
                    <div id="blogs-pagination"></div>
                </div>
                <div class="col-12 col-md-3">
                    <h3 class="text-dark">Categories</h3>
                    <ul class="list" id="blogs-categories"></ul>
                    <h3 class="text-dark">Archives</h3>
                    <ul class="list" id="blogs-archives"></ul>
                </div>
            </div>
        </div>
        <footer class="container-fluid text-center">
            <ul>
                <li class="nav-item">
                    <a class="nav-link" href="index.html">Home</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="about.html">About</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="menu.html">Menu</a>
                </li>
                <li class="nav-item active">
                    <a class="nav-link" href="blog.html">Blog</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="contact.html">Contacts</a>
                </li>
            </ul>
            <small>Ice-cream © 2019 | PRIVACY POLICY</small>
        </footer>
        <script type="text/javascript" src="js/jquery-3.4.1.js"></script>
        <script type="text/javascript" src="js/popper.min.js"></script>
        <script type="text/javascript" src="js/bootstrap.min.js"></script>
        <script type="text/javascript" src="js/handlebars-v4.1.2.js"></script>
        <script type="text/javascript" src="js/handlebars-pagination-helper.js"></script>
        <script type="text/javascript" src="icecream.js"></script>
        <script id="blogs-template" type="text/x-handlebars-template">
            {{#each data.data}}
               <div class="blogs py-3">
                     <div>
                        <h4>{{name}}</h4>
                        <div class="mb-3">by{{author}} in <a href="#" onclick="loadBlogs ('blogs/categories/{{categoryId}}');" > Blog. {{category.name}} </a>on {{format date}} Hits: 210 <a href="#">Comments ({{comments.length}})</a></div>
                        <div>
                            <img class="round-img" src="{{thumbpath}}" alt="" />
                            {{{summary}}}<br><br>
                                <a href="#" onclick="loadDetails ('{{id}}')">Read more</a>
                    </div>
                </div>
                    
            {{/each}}

    </script>
        <script id="blogs-details-template" type="text/x-handlebars-template">
            {{#each data}}
            <div class="blog py-3">
                <h4>{{name}}</h4>
                <div>by {{author}} in <a href="#"> Blog. {{category.name}} </a> on 
                    {{date}} Hits: 210 <a href="#comment"> Comments ({{comments.length}}) </a> </div>
                <div class="py-3">
                    <img src="{{thumbpath}}" alt="" class="round-img">
                    {{{description}}}         
                </div>              
            </div>        
            <div class="py-3">
                <h4 class="text-dark"> Leave your comment </h4>
                <h4 class="text-dark"> Post comment as a guest </h4>
                    <form id="form-comment" method="POST" onsubmit="return addComment()" data-blog-id="{{id}}">
                      <div class="form-row">
                        <div class="col">
                          Name:<input type="text" id="name" class="form-control my-2" required >
                        </div>
                        <div class="col">
                          Email:  <input type="email" id="email" class="form-control my-2" placeholder="email" required pattern='[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,3}$' oninput="this.setCustomValidity('')" oninvalid="this.setCustomValidity('Please enter an email address')"/>
                        </div>
                        <textarea class="form-control my-2" id="comment" row="3" name="comment" placeholder="comments" required></textarea>
                        <div class="col-6 m-0">
                            <input class="form-check-input my-2" type="checkbox" name="agree" id="agree" value="false" required> Agree to terms and conditions
                        </div>
                        <div class="col-6 text-right">
                             <button type="submit " class="btn btn-link btn-sm ">Submit Comment</button>
                        </div>
                      </div>
                    </form>
                <div class="bg-dark text-uppercase my-2"> Comments ({{comments.length}}) </div>
                {{#each comments}}
                    <div class="row px-4">
                        <div>
                            <small> <strong> {{name}} </strong> {{date}} 
                            <p> {{summary}} </p>
                            </small>
                        </div>
                        
                    </div>
                    <hr>
                {{/each}}
            </div>
        {{/each}}
    </script>
        <script id="blogs-categories-template" type="text/x-handlebars-template">
            {{#each data}}
        <li><a href="#" onclick="loadBlogs('blogs/categories/{{id}}')">Blogs.{{name}}</a></li>
        {{/each}}
    </script>
        <script id="blogs-archives-template" type="text/x-handlebars-template">
            {{#each data}}
        <li><a href="#" onclick="loadBlogs('blogs/archives/{{month}}-{{year}}')">{{monthString}},{{year}}</a></li>
        {{/each}}
    </script>
        <script id="blogs-pagination-template" type="text/x-handlebars-template">
            {{#pagination currentPage pageCount size api}}
            <nav aria-label="Page navigation" style="clear:both" class="py-3">
                <ul class="pagination">
                    {{#unless startFromFirstPage}}
                <li class="page-item disabled">
                  <a class="page-link" href="#" aria-label="Previous" onclick="loadBlogs('{{api}}',1)">
                    <span aria-hidden="true">&laquo;</span>
                    <span class="sr-only">Previous</span>
                  </a>
                </li>
                {{/unless}}
                {{#each pages}}
                {{#if isCurrent}}
                <li class="page-item active"><a class="page-link" href="#" onclick="loadBlogs('{{api}}','{{page}}')">{{page}}</a></li>
                {{else}}
                <li class="page-item"><a class="page-link" href="#" onclick="loadBlogs('{{api}}','{{page}}')">{{page}}</a></li>
                {{/if}}
               {{/each}}
               {{#unless endAtLastPage}}
                <li class="page-item">
                  <a class="page-link" href="#" aria-label="Next" onclick="loadBlogs('{{api}}','{{pageCount}}')" >
                    <span aria-hidden="true">&raquo;</span>
                    <span class="sr-only">Next</span>
                  </a>
                </li>
                {{/unless}}
                </ul>
            </nav>
            {{/pagination}}
    </script>
        <script>
        $(document).ready(function() {
            loadData('blogs-categories', '#blogs-categories', '#blogs-categories-template');
            loadData('blogs-archives', '#blogs-archives', '#blogs-archives-template');
            loadBlogs('blogs');
            Handlebars.registerHelper('format', date=> {
                var date=new Date(date);
                return date.toUTCString();
            })
        });

        function loadBlogs(request, page = 1) {
            //loadData(request,,);
            $.ajax({
                url: `https://web1-api.herokuapp.com/api/${request}?page=${page}`,
                cache: false,
                success: function(data) {
                    let jsonData = {
                        data: data
                    };
                    let target = $("#blogs");
                    let source = $("#blogs-template").html();
                    let template = Handlebars.compile(source);
                    $(target).html(template(jsonData));
                    jsonData = {
                        currentPage: page,
                        size: 2,
                        pageCount: data.pageCount,
                        api: request
                    };
                    target = $("#blogs-pagination");
                    source = $("#blogs-pagination-template").html();
                    template = Handlebars.compile(source);
                    $(target).html(template(jsonData));
                }

            });
        }

        function loadDetails(id) {
            loadData(`blogs/${id}`, '#blogs', '#blogs-details-template');
        }
        function addComment(){
            /*let formData = {
          name: $('#name').val(),
          email: $('#email').val(),
          comment: $('#comment').val(),
          blogId: $('#form-comment').data('blogId'),
          agree: $('#agree').prop('checked')
        };*/
            let formData={
                name:$('#name').val(),
                email:$('#email').val(),
                comment:$('#comment').val(),
                blogId:$('#form-comment').data('blogId'),
               agree:$('#agree').prop('checked')
            };
            $.ajax({
                url: "https://web1-api.herokuapp.com/users/authenticate",
                dataType: "json",
                type : "POST",
                data: {
                    username: 'test',
                    password: '1c3cr3@m'
                },
                success : function(r) {
                    $.ajax({
                        url: "https://web1-api.herokuapp.com/users/comment",
                        dataType: "json",
                        type : "POST",
                        headers: {
                            "Authorization": 'Bearer ' + r.token
                        },
                        data:formData,
                        success : function(r) {
                            loadDetails(formData.blogId);
                        },
                        error:function(xhr,status,error) {
                            window.alert(error);
                        }
                    });
                }
            });
            return false;
        }
        </script>
</body>

</html>